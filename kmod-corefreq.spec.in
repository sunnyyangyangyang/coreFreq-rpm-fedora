%global debug_package %{nil}

Name:           kmod-corefreq
Version:        @VERSION@
# Small Change: Using %{?dist} to work on all Fedora versions.
Release:        @RELEASE@%{?dist}
Summary:        CoreFreq kernel module
License:        GPL-2.0-only

Provides:       kernel-modules-for-kernel = %(uname -r)
Provides:       kmod-corefreq = @VERSION@

Source0:        CoreFreq-@VERSION@.tar.gz

%prep
%autosetup -n CoreFreq-@VERSION@

%build
make -C . KERNELDIR=%{_usrsrc}/kernels/%{kver} corefreqk.ko

%install
install -D -m 0755 build/corefreqk.ko %{buildroot}%{kmodinstdir}/corefreqk.ko

# SMALL CHANGE: Add the modules-load.d config to load the module on boot.
install -d -m 755 %{buildroot}%{_sysconfdir}/modules-load.d
echo corefreqk > %{buildroot}%{_sysconfdir}/modules-load.d/corefreq.conf

# SMALL CHANGE: Add post-install script for Secure Boot check and depmod.
%post
# After install, try to load the module and check for Secure Boot errors.
if ! /sbin/modprobe corefreqk >/dev/null 2>&1; then
    if dmesg | grep -q "Key was rejected by service"; then
        echo "------------------------------------------------------------------"
        echo "ATTENTION: SECURE BOOT"
        echo "The CoreFreq kernel module was built, but Secure Boot prevented it from loading."
        echo
        echo "To approve the key used by akmods, please follow these steps:"
        echo "1. Run this command: sudo mokutil --import /etc/pki/akmods/certs/public_key.der"
        echo "   (You will be asked to create a temporary password.)"
        echo "2. Reboot your computer."
        echo "3. At the blue 'MOK Manager' screen, enroll the key using the password."
        echo "------------------------------------------------------------------"
    fi
fi
/sbin/depmod -a %{kver}

%postun
/sbin/depmod -a %{kver}

%files
%kmod_files
# SMALL CHANGE: The package must own the config file it installs.
%config(noreplace) %{_sysconfdir}/modules-load.d/corefreq.conf